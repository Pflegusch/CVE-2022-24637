FROM alpine:3.8

ARG OWA_VERSION

ENV OWA_UID="82" \
    OWA_USER="www-data" \
    OWA_GID="82" \
    OWA_GROUP="www-data" \
    WEBROOT_DIR=/var/www/html

# Add OWA configuration
ADD config /tmp/owa-config

# Add application user and group
RUN set -ex \
	&& addgroup -g $OWA_UID -S $OWA_GROUP \
	&& adduser -u $OWA_GID -D -S -G $OWA_USER $OWA_GROUP \
# Install packages
    && apk update \
    && apk upgrade \
    && apk add --update tzdata \
    && apk --no-cache add \
    php7-fpm \    
    # php7-mysql \
    php7-mysqli \
    php7-pcntl \
    php7-json \
    php7-openssl \
    php7-curl \
    php7-zlib \
    php7-xml \
    php7-phar \
    php7-intl \
    php7-dom \
    php7-xmlreader \
    php7-ctype \
    php7-gd \
    nginx supervisor curl jq \
# Setup OWA configuration
    && cp /tmp/owa-config/nginx.conf /etc/nginx/nginx.conf \
    && cp /tmp/owa-config/owa-www.conf /etc/php7/php-fpm.d/ \
    && cp /tmp/owa-config/owa.ini /etc/php7/conf.d/ \
    && mkdir -p /etc/supervisor/conf.d \
    && cp /tmp/owa-config/supervisord.conf /etc/supervisor/conf.d/supervisord.conf \
    && cp /tmp/owa-config/entrypoint.sh /usr/bin/owa-entrypoint.sh \
    && chmod 0775 /usr/bin/owa-entrypoint.sh \
# Setup php-fpm unix user/group
    && echo "user=${OWA_USER}" >> /etc/php7/php-fpm.conf \
    && echo "group=${OWA_GROUP}" >> /etc/php7/php-fpm.conf \
# Add Open Web Analytics (OWA)
    && mkdir -p $WEBROOT_DIR \
    && echo "Install Open Web Analytics (OWA) version $OWA_VERSION" \
    && curl -fsSL -o /tmp/owa.tar "https://github.com/Open-Web-Analytics/Open-Web-Analytics/releases/download/$OWA_VERSION/owa_${OWA_VERSION}_packaged.tar" \
    && tar -xvf /tmp/owa.tar -C /tmp \
    && mv /tmp/* $WEBROOT_DIR \
    && chown -R $OWA_USER:$OWA_GROUP $WEBROOT_DIR/ \
    && chmod -R 0775 $WEBROOT_DIR/ \
    && apk del jq \
    && rm -rf /var/cache/apk/* /tmp/owa.tar.gz /tmp/owa-config 

WORKDIR $WEBROOT_DIR
EXPOSE 80 443
ENTRYPOINT ["/usr/bin/owa-entrypoint.sh"]
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
